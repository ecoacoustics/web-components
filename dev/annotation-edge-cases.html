<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web Components - Annotation Edge Cases</title>
    <script type="module" src="/src/components/index.ts"></script>
  </head>

  <body>
    <oe-annotate>
      <oe-spectrogram id="spectrogram" src="/example.flac">
        <source src="/example.flac" />
      </oe-spectrogram>

      <oe-annotation
        tags="high-freq-overflow"
        start-time="0.4"
        end-time="4.99"
        low-frequency="2500"
        high-frequency="3500"
      ></oe-annotation>

      <oe-annotation
        tags="low-freq-overflow"
        start-time="2.93"
        end-time="3.32"
        low-frequency="8000"
        high-frequency="9900"
      ></oe-annotation>

      <oe-annotation
        tags="start-time-overflow"
        start-time="2.93"
        end-time="3.32"
        low-frequency="8000"
        high-frequency="9900"
      ></oe-annotation>

      <oe-annotation
        tags="end-time-overflow"
        start-time="2.93"
        end-time="3.32"
        low-frequency="8000"
        high-frequency="9900"
      ></oe-annotation>

      <oe-annotation
        tags="time-overflow"
        start-time="2.93"
        end-time="3.32"
        low-frequency="8000"
        high-frequency="9900"
      ></oe-annotation>

      <oe-annotation
        tags="frequency-overflow"
        start-time="2.93"
        end-time="3.32"
        low-frequency="8000"
        high-frequency="9900"
      ></oe-annotation>

      <oe-annotation
        tags="all-overflow"
        start-time="2.93"
        end-time="3.32"
        low-frequency="8000"
        high-frequency="9900"
      ></oe-annotation>

      <oe-annotation
        tags="overlapping-annotation-first"
        start-time="2.93"
        end-time="3.32"
        low-frequency="8000"
        high-frequency="9900"
      ></oe-annotation>
      <oe-annotation
        tags="overlapping-annotation-second"
        start-time="2.93"
        end-time="3.32"
        low-frequency="8000"
        high-frequency="9900"
      ></oe-annotation>

      <oe-annotation
        tags="totally-offscreen"
        start-time="2.93"
        end-time="3.32"
        low-frequency="8000"
        high-frequency="9900"
      ></oe-annotation>

      <!--
        This is an interesting test because we can still render the
        annotations heading, but the bounding box will be hidden
      -->
      <oe-annotation
        tags="just-offscreen-low-time"
        start-time="2.93"
        end-time="3.32"
        low-frequency="8000"
        high-frequency="9900"
      ></oe-annotation>
    </oe-annotate>

    <div>
      <button onclick="zeroWidth()">Change to zero width</button>
      <button onclick="zeroHeight()">Change to zero height</button>
      <button onclick="changeSpectrogramOffset()">Change spectrogram offset</button>
    </div>

    <div>
      <h2>Window Controls</h2>
      <div class="window-controls">
        <div class="up-button"><button onclick="windowUp()">^</button></div>
        <button onclick="windowLeft()">&lt;</button>
        <button onclick="windowDown()">v</button>
        <button onclick="windowRight()">&gt;</button>

        <div class="zoom-controls">
          <button onclick="windowZoomOut()">+</button>
          <button onclick="windowZoomIn()">-</button>
        </div>
      </div>
    </div>

    <script>
      let spectrogramElement;
      const windowControlSensitivity = 20;

      window.addEventListener("load", () => {
        spectrogramElement = document.getElementById("spectrogram");
      });

      function zeroWidth() {
        spectrogramElement.style.width = "0px";
      }

      function zeroHeight() {
        spectrogramElement.style.height = "0px";
      }

      function changeSpectrogramOffset() {
        spectrogramElement.setAttribute("offset", "2");
      }

      function windowSize() {
        const windowAttribute = spectrogramElement.getAttribute("window");
        if (!windowAttribute) {
          return addWindowViewBox();
        }

        const [startOffset, lowFrequency, endOffset, highFrequency] = windowAttribute
          .split(",")
          .map((value) => parseFloat(value));

        return { startOffset, endOffset, lowFrequency, highFrequency };
      }

      // because we want to test the spectrogram element without a window view
      // box, we only add the window view box once we need it
      function addWindowViewBox() {
        const initialValue = {
          startOffset: 0,
          endOffset: 5,
          lowFrequency: 0,
          highFrequency: 22050,
        };

        setWindowViewBox(initialValue);

        return initialValue;
      }

      function setWindowViewBox(value) {
        const attributeValue = `${value.startOffset},${value.endOffset},${value.lowFrequency},${value.highFrequency}`;
        spectrogramElement.setAttribute("window", attributeValue);
      }

      // window modifiers
      function windowUp() {
        const windowValue = windowSize();
        windowValue.highFrequency += windowControlSensitivity;
        windowValue.lowFrequency += windowControlSensitivity;
        setWindowViewBox(windowValue);
      }

      function windowLeft() {
        const windowValue = windowSize();
        windowValue.startOffset -= windowControlSensitivity;
        windowValue.endOffset -= windowControlSensitivity;
        setWindowViewBox(windowValue);
      }

      function windowDown() {
        const windowValue = windowSize();
        windowValue.highFrequency -= windowControlSensitivity;
        windowValue.lowFrequency -= windowControlSensitivity;
        setWindowViewBox(windowValue);
      }

      function windowRight() {
        const windowValue = windowSize();
        windowValue.startOffset += windowControlSensitivity;
        windowValue.endOffset += windowControlSensitivity;
        setWindowViewBox(windowValue);
      }

      function windowZoomIn() {
        const windowValue = windowSize();
        windowValue.startOffset += windowControlSensitivity;
        windowValue.endOffset += windowControlSensitivity;
        windowValue.highFrequency += windowControlSensitivity;
        windowValue.lowFrequency += windowControlSensitivity;
        setWindowViewBox(windowValue);
      }

      function windowZoomOut() {
        const currentValue = windowSize();
      }
    </script>

    <style>
      oe-spectrogram {
        height: 600px;
      }

      .window-controls {
        display: inline-block;
        width: fit-content;

        & > * {
          margin: 0.1rem;
        }

        button {
          padding: 0.5rem;
        }

        .up-button {
          display: flex;
          justify-content: center;
        }

        .zoom-controls {
          margin-top: 0.5rem;
        }
      }
    </style>
  </body>
</html>
